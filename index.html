<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta property="og:title" content="è‡ªåŠ©é›»å­è½å–®è¡¨">
    <meta property="og:description" content="é¦™æ¸¯å®é”æœ‰é™å…¬å¸æä¾›">
    <title>å®é”è½å–®ç‹</title>

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#212529">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body { 
            font-family: "Microsoft JhengHei", sans-serif; 
            background-color: #f8f9fa; 
            padding-bottom: 160px; /* åº•éƒ¨é ç•™ç©ºé–“ */
            -webkit-overflow-scrolling: touch; 
        }

        /* === é ‚éƒ¨å®¹å™¨ (Sticky - æœ€ç©©å®šæ–¹æ¡ˆ) === */
        .sticky-header-container { 
            position: sticky; 
            position: -webkit-sticky; /* å…¼å®¹ Safari */
            top: 0; 
            z-index: 1020; 
            background-color: #212529; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
            width: 100%;
            padding-top: env(safe-area-inset-top); /* é¿é–‹åŠ‰æµ· */
            margin-top: -1px;
        }

        /* é ‚éƒ¨è³‡è¨Šæ¬„ */
        .top-info { 
            padding: 10px 15px 5px 15px; 
            color: white; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: relative;
            z-index: 2;
        }

        .client-name { font-size: 1.3rem; font-weight: 800; color: #ffc107; cursor: pointer; }

        /* å°èˆªæ¨™ç±¤ */
        .nav-tabs { 
            border-bottom: none; 
            padding: 0 10px; 
            background-color: #212529; 
            position: relative;
            z-index: 2;
        }
        .nav-link { color: #aaa; font-weight: bold; border: none; border-radius: 10px 10px 0 0; padding: 10px 15px; font-size: 1rem; background: transparent; }
        .nav-link.active { background-color: #f8f9fa; color: #000; border-bottom: 4px solid #ffc107; }

        /* æœç´¢æ¬„ */
        .search-section { background-color: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #ddd; display: none; }
        .search-wrapper { position: relative; }
        .search-input { border-radius: 20px; border: 1px solid #ccc; padding: 8px 35px 8px 15px; width: 100%; }
        .btn-clear-search { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #adb5bd; cursor: pointer; font-size: 1.1rem; display: none; z-index: 10; }

        /* åˆ†é¡æ¨™é¡Œ */
        .cat-header { 
            background-color: #ffc107; 
            color: #000; 
            font-weight: 800; 
            padding: 8px 15px; 
            margin-top: 0; 
            font-size: 1.1rem; 
            border-bottom: 1px solid #e0a800;
            position: relative; 
            z-index: 1;
        }

        /* ç”¢å“åˆ—è¡¨æ¨£å¼ */
        .product-row { background: white; border-bottom: 1px solid #eee; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        .product-row.oos { background-color: #f8f9fa; opacity: 0.8; }
        .p-info { flex: 1; padding-right: 10px; overflow: hidden; }
        .p-name { font-size: 1.1rem; font-weight: 700; color: #000; line-height: 1.3; margin-bottom: 2px; }
        .p-code { font-size: 0.85rem; color: #888; font-weight: normal; font-family: Arial, sans-serif; }
        .oos-badge { font-size: 0.8rem; background-color: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle; }

        /* æ•¸é‡æ§åˆ¶å™¨ */
        .qty-control { display: flex; align-items: center; background: #fff; border: 1px solid #ced4da; border-radius: 8px; width: 120px; justify-content: space-between; height: 38px; flex-shrink: 0; overflow: hidden; }
        .qty-control.disabled { background: #e9ecef; border-color: #dee2e6; }
        .qty-btn { width: 35px; height: 100%; border-radius: 0; background: #f8f9fa; color: #212529; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 1.2rem; user-select: none; border: none; }
        .qty-btn:active { background: #ffc107; }
        .qty-btn.disabled { color: #adb5bd; cursor: not-allowed; background: #e9ecef; }
        .qty-input { width: 50px; text-align: center; border: none; font-weight: bold; font-size: 1.1rem; color: #333; background: transparent; padding: 0; }
        .qty-input.unit-kg { color: #d63384; font-size: 1rem; }
        .product-row.selected { background-color: #fff9db; border-left: 5px solid #ffc107; }

        /* åº•éƒ¨è³¼ç‰©è»Š */
        .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; box-shadow: 0 -4px 15px rgba(0,0,0,0.15); padding: 10px 15px; z-index: 1030; display: flex; flex-direction: column; gap: 8px; }
        .bottom-info-row { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 2px; }
        .bottom-btn-row { display: flex; gap: 8px; width: 100%; }
        .total-box { font-size: 1.1rem; font-weight: bold; color: #333; }
        .total-num { color: #d32f2f; font-size: 1.4rem; padding: 0 3px; }
        .btn-view-cart { background-color: #6c757d; color: white; border: none; padding: 6px 15px; border-radius: 50px; font-weight: bold; font-size: 0.9rem; transition: all 0.3s ease; }
        .btn-view-cart.active { background: linear-gradient(45deg, #ff9800, #ff5722); box-shadow: 0 2px 8px rgba(255, 87, 34, 0.4); }
        .btn-send { border: none; padding: 12px 5px; border-radius: 10px; font-weight: bold; font-size: 1rem; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px; color: white; transition: transform 0.1s; }
        .btn-send:active { transform: scale(0.98); }
        .btn-sales { background-color: #25D366; box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3); } 
        .btn-group { background-color: #0d6efd; box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3); }

        /* å½ˆçª—èˆ‡è¨­å®š */
        .modal-footer { display: flex; gap: 8px; padding: 15px; justify-content: space-between; flex-wrap: wrap; }
        .modal-footer .btn { flex: 1; min-width: 100px; }
        .modal-footer .btn-outline-danger { flex: 0 0 auto; min-width: auto; border-radius: 50px; padding: 8px 15px; } 
        .modal-footer .btn-secondary { display: none; }
        .tab-content { display: none; padding-top: 10px; }
        .tab-content.active { display: block; }
        .modal-header { background-color: #212529; color: white; }
        .modal-title { font-weight: bold; color: #ffc107; }

        .unit-btn-group { display: flex; gap: 15px; justify-content: center; padding: 20px; }
        .btn-unit-select { flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 10px; background: white; font-weight: bold; font-size: 1.1rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .btn-unit-select:hover { background-color: #f8f9fa; }
        .btn-unit-select.piece { border-color: #212529; color: #212529; }
        .btn-unit-select.kg { border-color: #d63384; color: #d63384; }

        .freq-divider { text-align: center; margin: 20px 0; font-size: 0.85rem; color: #aaa; position: relative; }
        .freq-divider:before { content: ""; position: absolute; top: 50%; left: 15%; width: 25%; height: 1px; background: #ddd; }
        .freq-divider:after { content: ""; position: absolute; top: 50%; right: 15%; width: 25%; height: 1px; background: #ddd; }
        
        .setup-input-group { margin-bottom: 15px; text-align: left; }
        .setup-label { font-weight: bold; margin-bottom: 5px; display: block; color: #333; }
        .setup-input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .setup-input:focus { border-color: #ffc107; outline: none; }
        .btn-setup-save { width: 100%; background-color: #ffc107; color: black; font-weight: bold; padding: 12px; border: none; border-radius: 8px; font-size: 1.1rem; margin-top: 10px; }
        
        .admin-controls { text-align: center; margin: 40px 0 20px 0; padding-top: 20px; border-top: 1px dashed #ddd; display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .btn-reset { padding: 8px 20px; border-radius: 50px; font-size: 0.9rem; transition: all 0.2s; cursor: pointer; border: 1px solid; background: white; width: fit-content; }
        .btn-reset-freq { color: #6c757d; border-color: #ced4da; }
        .btn-reset-freq:hover { background: #f8f9fa; color: #495057; border-color: #adb5bd; }
        .btn-logout { color: #d32f2f; border-color: #f5c6cb; }
        .btn-logout:hover { background: #fff5f5; color: #a50e0e; border-color: #d32f2f; }
    </style>
</head>
<body onload="init()">

    <script src="sales_config.js"></script>
    <script src="customers.js"></script>
    <script src="products.js"></script> 

    <div class="sticky-header-container">
        <div class="top-info">
            <div id="backToAdminBtn" style="display:none; margin-right: 15px; cursor: pointer;">
                <i class="bi bi-arrow-left-circle-fill" style="font-size: 1.8rem; color: #ffc107;"></i>
            </div>

            <div id="clientInfoWrapper" onclick="openSetupModal()" style="flex: 1;">
                <div class="client-name" id="displayClientName">è¨­å®šå®¢æˆ¶ <i class="bi bi-pencil-square" style="font-size:0.8em"></i></div>
                <div style="font-size: 0.8rem; color: #ccc;" id="displayClientCode">é»æ“Šæ­¤è™•è¨­å®š</div>
            </div>
            
            <div style="text-align: right; font-size: 0.8rem; color: #ccc;">
                <span id="displaySalesName">å®é”æ‰¹ç™¼</span><br>Tel: <span id="displayPhone"></span>
            </div>
        </div>

        <ul class="nav nav-tabs nav-fill">
            <li class="nav-item">
                <button class="nav-link active" id="tab-freq" onclick="switchTab('frequent')"><i class="bi bi-star-fill text-warning"></i> å¸¸ç”¨æ¸…å–®</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="tab-all" onclick="switchTab('all')"><i class="bi bi-clipboard-check"></i> å…¨éƒ¨ç”¢å“</button>
            </li>
        </ul>

        <div class="search-section" id="searchBar">
            <div class="search-wrapper">
                <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” æœå°‹ç”¢å“ / ç·¨è™Ÿ..." oninput="filterAllProducts()">
                <i class="bi bi-x-circle-fill btn-clear-search" id="clearSearchBtn" onclick="clearSearch()"></i>
            </div>
        </div>
    </div>

    <div id="tab-frequent" class="tab-content active">
        <div class="text-center p-5 text-muted" id="emptyFrequentMsg">
            <i class="bi bi-basket3" style="font-size: 2rem;"></i><br><br>
            æ‚¨çš„å¸¸ç”¨æ¸…å–®ç›®å‰æ˜¯ç©ºçš„ã€‚<br>
            è«‹åˆ°ã€Œå…¨éƒ¨ç”¢å“ã€é é¢é¸è³¼ï¼Œ<br>ç³»çµ±æœƒè‡ªå‹•è¨˜æ†¶æ‚¨çš„é¸æ“‡ï¼
        </div>
        <div id="frequentListContent"></div>
        <div class="admin-controls" id="adminControls">
            <button class="btn-reset btn-reset-freq" onclick="resetFrequentList()" id="btnResetFreq" style="display:none;">
                <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®å¸¸ç”¨æ¸…å–®
            </button>
            <button class="btn-reset btn-logout" onclick="logoutUser()">
                <i class="bi bi-box-arrow-right"></i> ç™»å‡º / é‡ç½®èº«ä»½
            </button>
        </div>
    </div>

    <div id="tab-all" class="tab-content"></div>

    <div class="bottom-bar">
        <div class="bottom-info-row">
            <div class="total-box">å…± <span id="totalQty" class="total-num">0</span> æ¬¾</div>
            <button id="viewCartBtn" class="btn-view-cart" onclick="openCartModal()" disabled><i class="bi bi-cart3"></i> æŸ¥çœ‹å·²é¸</button>
        </div>
        <div class="bottom-btn-row">
            <button class="btn-send btn-sales" onclick="sendWhatsApp('direct')"><i class="bi bi-whatsapp"></i> ç™¼é€çµ¦éŠ·å”®</button>
            <button class="btn-send btn-group" onclick="sendWhatsApp('group')"><i class="bi bi-people-fill"></i> ç™¼é€åˆ°ç¾¤çµ„</button>
        </div>
    </div>

    <div class="modal fade" id="setupModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">âš™ï¸ å®¢æˆ¶è³‡æ–™è¨­å®š</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" id="setupCloseBtn" style="display:none;"></button>
                </div>
                <div class="modal-body">
                    <div class="setup-input-group">
                        <label class="setup-label">å®¢æˆ¶åç¨± / åº—é‹ªå</label>
                        <input type="text" id="inputClientName" class="setup-input" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„é¤å»³">
                    </div>
                    <div class="setup-input-group">
                        <label class="setup-label">å®¢æˆ¶ç·¨è™Ÿ (æˆ–å¡«å¯« æ–°å®¢æˆ¶)</label>
                        <input type="text" id="inputClientCode" class="setup-input" placeholder="ä¾‹å¦‚ï¼šA1234">
                    </div>
                    <button class="btn-setup-save" onclick="saveClientDetails()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="unitSelectionModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">è«‹é¸æ“‡è¨ˆåƒ¹å–®ä½</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body">
                    <p class="text-center mb-3">æ­¤ç”¢å“æ”¯æŒç¨±é‡è¨ˆåƒ¹ï¼Œè«‹ç¢ºèªå–®ä½ï¼š</p>
                    <div class="unit-btn-group">
                        <button id="btn-unit-left" class="btn-unit-select"><i class="bi bi-box-seam"></i> å·¦æŒ‰éˆ•</button>
                        <button id="btn-unit-right" class="btn-unit-select"><i class="bi bi-speedometer2"></i> å³æŒ‰éˆ•</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="cartModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">å·²é¸ç”¢å“æ¸…å–®</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body" id="cartModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" onclick="clearCart()"><i class="bi bi-trash"></i> æ¸…ç©º</button>
                    <button type="button" class="btn btn-send btn-sales" onclick="sendWhatsApp('direct')">ç™¼çµ¦éŠ·å”®</button>
                    <button type="button" class="btn btn-send btn-group" onclick="sendWhatsApp('group')">ç™¼åˆ°ç¾¤çµ„</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 2. åˆå§‹åŒ–æ ¸å¿ƒè®Šæ•¸
        let currentClientBoxItems = []; 
        let currentClientAliasCodes = {}; 
        let currentSalesPhone = ""; 
        let salesID = "A"; 
        let customerName = ""; 
        let customerCode = "";
        
        let storageKey = ""; 
        let profileKey = ""; 
        let itemCounts = {}; 
        let learnedFrequent = []; 
        let presetFrequent = []; 
        let productMap = {}; // é€™è£¡ç›´æ¥ä½¿ç”¨å…¨å±€å®šç¾©
        let cart = {};
        let cartUnits = {};
        let cartModal, unitModal, setupModal; 
        let pendingProductCode = null;

        const outOfStockCodes = ["D58C","D10F","D10A","D10D","D09M","D09G"];
        const eelProducts = ["D22J", "D22L", "D22", "D22C", "D22A", "D22D", "D22I", "D22G"];
        const weightedProducts = ["D61B", "D61C", "D18A", "D17E", "D17C", "B01", "D18"];
        
        function init() {
            // åˆå§‹åŒ– Bootstrap Modals
            cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
            unitModal = new bootstrap.Modal(document.getElementById('unitSelectionModal'));
            setupModal = new bootstrap.Modal(document.getElementById('setupModal'));

            // 1. è¿”å›æŒ‰éˆ•é‚è¼¯ (é€™è£¡ç¢ºä¿æœ‰ btn)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('source') === 'admin') {
                const btn = document.getElementById('backToAdminBtn');
                if(btn) {
                    btn.style.display = 'block';
                    btn.onclick = function() {
                        window.location.href = 'admin.html';
                    };
                }
            }

            // 2. æ§‹å»ºç”¢å“åœ°åœ– (ç›´æ¥ä¾è³´å¤–éƒ¨çš„ products.js)
            productMap = {};
            if (typeof products !== 'undefined') {
                for(let p of products){
                    productMap[p.code] = p;
                }
            } else {
                console.error("ç„¡æ³•è®€å– products.js");
            }

            // 3. è­˜åˆ¥ç”¨æˆ¶èˆ‡æ¸²æŸ“é é¢
            identifyUser();
            renderAll();
            renderFrequent();
            loadCart(); 
            calcTotal();

            // ç›£è½æ»¾å‹•å„ªåŒ–
            window.addEventListener('scroll', function() {
                const s = document.getElementById('searchBar');
                if(s) {
                    if(window.scrollY > 50 && document.getElementById('searchInput').value === '') s.style.display = 'block';
                }
            });
        }
        
        function identifyUser() {
            const urlParams = new URLSearchParams(window.location.search);
            const clientID = urlParams.get('id');
            const logoutBtn = document.querySelector('.btn-logout');
            const clientWrapper = document.getElementById('clientInfoWrapper');

            if (clientID && typeof clientDB !== 'undefined' && clientDB[clientID]) {
                // === è€å®¢æˆ¶æ¨¡å¼ ===
                const client = clientDB[clientID];
                customerName = client.name;
                customerCode = client.realID || clientID;
                salesID = client.sales || "A"; 
                presetFrequent = client.list || []; 

                if (client.box_items) {
                    currentClientBoxItems = client.box_items;
                } else {
                    currentClientBoxItems = [];
                }

                if (client.alias_codes) {
                    currentClientAliasCodes = client.alias_codes;
                } else {
                    currentClientAliasCodes = {};
                }
                
                document.getElementById('displayClientName').innerHTML = customerName;
                document.getElementById('displayClientCode').innerText = customerCode;
                
                // é–å®šå®¢æˆ¶è³‡æ–™é»æ“Š (é˜²æ­¢èª¤è§¸)
                if(clientWrapper) {
                    clientWrapper.onclick = null; 
                    clientWrapper.style.pointerEvents = 'none';
                }
                
                if(logoutBtn) logoutBtn.style.display = 'none';
                storageKey = "client_user_" + clientID;

            } else {
                // === æ–°å®¢æˆ¶æ¨¡å¼ ===
                salesID = urlParams.get('sales') || "A";
                profileKey = "gen_profile_" + salesID; 
                storageKey = "gen_user_" + salesID;

                customerName = localStorage.getItem(profileKey + "_name") || "";
                customerCode = localStorage.getItem(profileKey + "_code") || "";
                updateClientInfoUI(); 
                
                // å…è¨±æ–°å®¢æˆ¶ä¿®æ”¹è³‡æ–™
                if(clientWrapper) {
                    clientWrapper.onclick = openSetupModal;
                    clientWrapper.style.pointerEvents = 'auto';
                }
                
                if(logoutBtn) logoutBtn.style.display = 'inline-block';
            }
            
            if (typeof salesTeam !== 'undefined' && salesTeam[salesID]) {
                currentSalesPhone = salesTeam[salesID].phone;
                document.getElementById('displaySalesName').innerText = "å®é” (" + salesTeam[salesID].name + ")";
            } else {
                document.getElementById('displaySalesName').innerText = "å®é”æ‰¹ç™¼";
            }
            document.getElementById('displayPhone').innerText = currentSalesPhone;
            
            const savedStats = localStorage.getItem(storageKey + '_stats');
            if(savedStats) { try { itemCounts = JSON.parse(savedStats); } catch(e) {} }
            learnedFrequent = Object.keys(itemCounts);
        }
        
        function openSetupModal(allowClose = true) {
            document.getElementById('inputClientName').value = customerName;
            document.getElementById('inputClientCode').value = customerCode;
            const closeBtn = document.getElementById('setupCloseBtn');
            closeBtn.style.display = allowClose ? 'block' : 'none';
            setupModal.show();
        }

        function saveClientDetails() {
            const name = document.getElementById('inputClientName').value.trim();
            const code = document.getElementById('inputClientCode').value.trim();
            if(!name || !code) { alert("è«‹è¼¸å…¥å®Œæ•´çš„åç¨±å’Œç·¨è™Ÿï¼"); return; }
            
            customerName = name;
            customerCode = code;
            localStorage.setItem(profileKey + "_name", customerName);
            localStorage.setItem(profileKey + "_code", customerCode);
            
            updateClientInfoUI();
            setupModal.hide();
        }

        function updateClientInfoUI() {
            if(customerName) document.getElementById('displayClientName').innerHTML = customerName + ' <i class="bi bi-pencil-square" style="font-size:0.8em"></i>';
            if(customerCode) document.getElementById('displayClientCode').innerText = customerCode;
        }

        function logoutUser() {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºä¸¦æ¸…é™¤æ­¤è£ç½®ä¸Šçš„å®¢æˆ¶è³‡æ–™å—ï¼Ÿ\n(å¸¸ç”¨æ¸…å–®å’Œè³¼ç‰©è»Šä¹Ÿæœƒè¢«æ¸…ç©º)")) {
                if(profileKey) {
                    localStorage.removeItem(profileKey + "_name");
                    localStorage.removeItem(profileKey + "_code");
                }
                localStorage.removeItem(storageKey + '_stats');
                localStorage.removeItem('orderCart_'+storageKey);
                localStorage.removeItem('orderUnits_'+storageKey);
                location.reload(); 
            }
        }
        
        function getDeliveryDate() {
            const now = new Date();
            const hour = now.getHours();
            let targetDate = new Date(now);
            if (hour >= 11) targetDate.setDate(targetDate.getDate() + 1);
            if (targetDate.getDay() === 0) targetDate.setDate(targetDate.getDate() + 1);
            
            const y = targetDate.getFullYear();
            const m = String(targetDate.getMonth() + 1).padStart(2, '0');
            const d = String(targetDate.getDate()).padStart(2, '0');
            const w = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"][targetDate.getDay()];
            return `${y}-${m}-${d} (${w})`;
        }

        function loadCart() {
            const c=localStorage.getItem('orderCart_'+storageKey), u=localStorage.getItem('orderUnits_'+storageKey);
            if(c)try{cart=JSON.parse(c)}catch(e){} if(u)try{cartUnits=JSON.parse(u)}catch(e){}
        }
        function saveCart() {
            localStorage.setItem('orderCart_'+storageKey, JSON.stringify(cart));
            localStorage.setItem('orderUnits_'+storageKey, JSON.stringify(cartUnits));
        }
        
        function switchTab(t){
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active'));
            
            let tabId = (t === 'frequent') ? 'tab-frequent' : 'tab-all';
            let btnId = (t === 'frequent') ? 'tab-freq' : 'tab-all';
            
            document.getElementById(tabId).classList.add('active');
            document.getElementById(btnId).classList.add('active');
            
            if(t==='all'){
                clearSearch();
                document.getElementById('searchBar').style.display='block';
                window.scrollTo(0,0);
            } else {
                document.getElementById('searchBar').style.display='none';
            }
        }
        
        function renderFrequent(){
            const c=document.getElementById('frequentListContent');
            const emptyMsg = document.getElementById('emptyFrequentMsg');
            const resetBtn = document.getElementById('btnResetFreq');
            let h='';
            
            if (presetFrequent.length > 0) {
                // è€å®¢æˆ¶ï¼šé è¨­æ¸…å–®
                presetFrequent.forEach(code => {
                    const p = productMap[code];
                    if(p) h += createProductRow(p.fullName);
                });

                // è€å®¢æˆ¶ï¼šæœ€è¿‘æ–°å¢
                let sortedKeys = Object.keys(itemCounts).sort((a,b) => {
                    let diff = itemCounts[b] - itemCounts[a];
                    return diff !== 0 ? diff : a.localeCompare(b);
                });
                let newAddedItems = sortedKeys.filter(code => !presetFrequent.includes(code));

                if (newAddedItems.length > 0) {
                    h += `<div class="freq-divider">ğŸ‘‡ æœ€è¿‘æ–°å¢ç”¢å“ ğŸ‘‡</div>`;
                    newAddedItems.forEach(code => {
                        const p = productMap[code];
                        if(p) h += createProductRow(p.fullName);
                    });
                    resetBtn.innerHTML = '<i class="bi bi-trash"></i> æ¸…é™¤æœ€è¿‘æ–°å¢';
                    resetBtn.style.display = 'inline-block';
                } else {
                    resetBtn.style.display = 'none';
                }
                emptyMsg.style.display = 'none';
                c.innerHTML = h;

            } else {
                // æ–°å®¢æˆ¶ï¼šå­¸ç¿’æ¸…å–®
                let sortedKeys = Object.keys(itemCounts).sort((a,b) => {
                    let diff = itemCounts[b] - itemCounts[a];
                    return diff !== 0 ? diff : a.localeCompare(b);
                });

                if (sortedKeys.length > 0) {
                    sortedKeys.forEach(code=>{
                        const p=productMap[code];
                        if(p) h+=createProductRow(p.fullName);
                    });
                    emptyMsg.style.display = 'none';
                    resetBtn.style.display = 'inline-block'; 
                    resetBtn.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> é‡ç½®å¸¸ç”¨æ¸…å–®';
                    c.innerHTML = h;
                } else {
                    emptyMsg.style.display = 'block';
                    resetBtn.style.display = 'none'; 
                    c.innerHTML = '';
                }
            }
        }

        function resetFrequentList() {
            const isOldClient = presetFrequent.length > 0;
            const msg = isOldClient 
                ? "ç¢ºå®šè¦æ¸…é™¤ã€Œæœ€è¿‘æ–°å¢ã€çš„ç”¢å“è¨˜éŒ„å—ï¼Ÿ\n(åŸæœ¬çš„å›ºå®šæ¸…å–®ä¸æœƒå—å½±éŸ¿)" 
                : "ç¢ºå®šè¦é‡ç½®å¸¸ç”¨æ¸…å–®å—ï¼Ÿ\né€™å°‡æ¸…ç©ºæ‰€æœ‰è‡ªå‹•è¨˜æ†¶çš„ç”¢å“ã€‚";

            if(confirm(msg)) {
                itemCounts = {};
                learnedFrequent = [];
                localStorage.removeItem(storageKey + '_stats');
                renderFrequent();
            }
        }
        
        function renderAll(f=''){
            if (typeof categories === 'undefined') return;
            const c=document.getElementById('tab-all');
            let h='';
            const t=f.toUpperCase().split('');
            
            categories.forEach(cat=>{
                // å¾ products æ•¸æ“šä¸­éæ¿¾
                const items=products.filter(p => p.cat === cat && (
                    !f || t.every(x => p.fullName.toUpperCase().includes(x))
                ));
                if(items.length>0){
                    if(!f)h+=`<div class="cat-header">${cat}</div>`;
                    items.forEach(p=>h+=createProductRow(p.fullName))
                }
            });
            if(h==='')h='<div class="text-center p-5 text-muted">æ‰¾ä¸åˆ°ç›¸é—œç”¢å“</div>';
            c.innerHTML=h + '<div style="height:80px"></div>'; 
        }
        
        function createProductRow(s){
            let n=s,c='UNKNOWN';
            const m=s.match(/^(.*)\s*\(([A-Za-z0-9]+)\)$/);
            if(m){n=m[1];c=m[2]}else{c=s.replace(/[^a-zA-Z0-9]/g,'')}

            // é»ƒè‰²åŸç®±æ¨™ç±¤
            if (currentClientBoxItems.includes(c)) {
                n += ' <span style="background-color:#ffc107; color:#000; padding:1px 5px; border-radius:4px; font-size:0.8rem; font-weight:bold; margin-left:5px;">ğŸ“¦ åŸç®±</span>';
            }

            if (outOfStockCodes.includes(c)) return `<div class="product-row oos" id="row-${c}"><div class="p-info"><div class="p-name">${n} <span class="oos-badge">ğŸš« ç¼ºè²¨</span></div><div class="p-code">${c}</div></div><div class="qty-control disabled"><div class="qty-btn disabled">-</div><input type="text" class="qty-input" value="0" readonly disabled><div class="qty-btn disabled">+</div></div></div>`;
            
            const q=cart[c]||0; 
            let val=q, cls='qty-input'; 
            if(q>0&&cartUnits[c]==='kg'){val+=' K';cls+=' unit-kg'}
            const sel=q>0?'selected':'';
            
            return `<div class="product-row ${sel}" id="row-${c}"><div class="p-info"><div class="p-name">${n}</div><div class="p-code">${c}</div></div><div class="qty-control"><div class="qty-btn" onclick="updateQty('${c}',-1)">-</div><input type="text" class="${cls}" id="qty-${c}" value="${val}" readonly><div class="qty-btn" onclick="updateQty('${c}',1)">+</div></div></div>`
        }
        
        function filterAllProducts(){const v=document.getElementById('searchInput').value;document.getElementById('clearSearchBtn').style.display=v.length?'block':'none';renderAll(v)}
        function clearSearch(){document.getElementById('searchInput').value='';document.getElementById('clearSearchBtn').style.display='none';renderAll('')}
        
        function updateQty(c,d){
            if (outOfStockCodes.includes(c)) return;
            if(eelProducts.includes(c)){
                if(d>0&&(!cart[c]||cart[c]===0)){cart[c]=5;cartUnits[c]='kg'}else{if(!cart[c])cart[c]=0;cart[c]+=d*5}
                if(cart[c]<=0){delete cart[c];delete cartUnits[c]}
                syncUI(c); return;
            }
            if(d>0&&(!cart[c]||cart[c]===0)&&weightedProducts.includes(c)&&!cartUnits[c]){
                pendingProductCode=c;
                const leftBtn = document.getElementById('btn-unit-left');
                const rightBtn = document.getElementById('btn-unit-right');
                leftBtn.className = 'btn-unit-select';
                rightBtn.className = 'btn-unit-select';
                if (c === 'B01') {
                    leftBtn.classList.add('kg'); leftBtn.innerHTML = '<i class="bi bi-speedometer2"></i> KG<br>(é»˜èª)'; leftBtn.onclick = function() { confirmUnit('kg'); };
                    rightBtn.classList.add('piece'); rightBtn.innerHTML = '<i class="bi bi-box-seam"></i> éš»'; rightBtn.onclick = function() { confirmUnit('piece'); };
                } else {
                    leftBtn.classList.add('piece'); leftBtn.innerHTML = '<i class="bi bi-box-seam"></i> ä»¶ / åŒ…<br>(é»˜èª)'; leftBtn.onclick = function() { confirmUnit('piece'); };
                    rightBtn.classList.add('kg'); rightBtn.innerHTML = '<i class="bi bi-speedometer2"></i> KG<br>(å…¬æ–¤)'; rightBtn.onclick = function() { confirmUnit('kg'); };
                }
                unitModal.show(); return;
            }
            if(!cart[c])cart[c]=0; cart[c]+=d;
            if(cart[c]<=0){delete cart[c];delete cartUnits[c]}
            syncUI(c);
        }
        
        function confirmUnit(u){if(pendingProductCode){cartUnits[pendingProductCode]=u;updateQty(pendingProductCode,1);unitModal.hide();pendingProductCode=null}}
        
        function syncUI(c){
            const q=cart[c]||0, u=cartUnits[c];
            document.querySelectorAll(`#qty-${c}`).forEach(i=>{
                i.className='qty-input'+(u==='kg'?' unit-kg':'');
                i.value=q+(u==='kg'?' K':'');
                const r=i.closest('.product-row');
                if(r&&!r.classList.contains('modal-row')){q>0?r.classList.add('selected'):r.classList.remove('selected')}
            });
            calcTotal(); saveCart(); if(document.getElementById('cartModal').classList.contains('show'))renderCartModalItems();
        }
        
        function clearCart(){if(Object.keys(cart).length===0)return;if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å·²é¸è²¨å“å—ï¼Ÿ")){cart={};cartUnits={};localStorage.removeItem('orderCart_'+storageKey);localStorage.removeItem('orderUnits_'+storageKey);renderFrequent();renderAll();calcTotal();renderCartModalItems()}}
        
        function calcTotal(){
            const count=Object.keys(cart).length; document.getElementById('totalQty').innerText=count;
            const b=document.getElementById('viewCartBtn');
            if(count>0){b.classList.add('active');b.disabled=false;b.innerHTML=`<i class="bi bi-cart-check-fill"></i> æŸ¥çœ‹å·²é¸ (${count})`}else{b.classList.remove('active');b.disabled=true;b.innerHTML=`<i class="bi bi-cart3"></i> æŸ¥çœ‹å·²é¸`}
        }
        function openCartModal(){renderCartModalItems();cartModal.show()}
        function renderCartModalItems(){
            const c=document.getElementById('cartModalBody');
            if(Object.keys(cart).length===0){c.innerHTML='<div class="text-center p-4 text-muted">å°šæœªé¸æ“‡ä»»ä½•ç”¢å“</div>';return}
            let h=''; for(let k in cart){const p=productMap[k];h+=createProductRow(p?p.fullName:`${k} (æœªçŸ¥)`);} c.innerHTML=h;
        }
        
        function sendWhatsApp(mode){
            if(!customerName || !customerCode) { alert("è«‹å…ˆè¨­å®šå®¢æˆ¶è³‡æ–™ï¼"); openSetupModal(); return; }
            if(Object.keys(cart).length===0){alert("è«‹å…ˆé¸æ“‡ç”¢å“ï¼");return}
            
            const dateStr = getDeliveryDate();
            let msg=`${customerCode} ${customerName}\næ—¥æœŸï¼š${dateStr}\nè¨‚è²¨å–®ï¼š\n\n`;
            
            const urlParams = new URLSearchParams(window.location.search);
            const clientID = urlParams.get('id');
            const currentClient = (typeof clientDB !== 'undefined' && clientID) ? clientDB[clientID] : null;

            const fmt = c => {
                const p = productMap[c];
                const n = p ? p.name : c;
                let q = cart[c].toString();

                if(cartUnits[c] === 'kg') { 
                    q += 'K';
                } 
                else if(cartUnits[c] === 'piece' && c === 'B01') { 
                    q += 'éš»';
                } 
                else if (currentClient && currentClient.box_items && currentClient.box_items.includes(c)) {
                    q += 'ç®±'; 
                }

                // ä»£ç¢¼è½‰æ› (Alias)
                let displayCode = c;
                if (currentClient && currentClient.alias_codes && currentClient.alias_codes[c]) {
                    displayCode = currentClient.alias_codes[c];
                }

                return ` ${q.padEnd(5,' ')} ${n} (${displayCode})\n`;
            };
            
            let codes = Object.keys(cart).sort(); 
            let hasNewItems = false;
            for(let c of codes){
                msg+=fmt(c);
                if(itemCounts[c]) itemCounts[c]++;
                else itemCounts[c] = 1;
                hasNewItems = true;
            }
            
            if(hasNewItems){
                localStorage.setItem(storageKey + '_stats', JSON.stringify(itemCounts));
            }

            if (mode === 'direct') {
                window.open(`https://api.whatsapp.com/send?phone=852${currentSalesPhone}&text=${encodeURIComponent(msg)}`,'_blank');
            } else {
                window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`,'_blank');
            }
            
            setTimeout(() => {
                cart = {}; cartUnits = {};
                saveCart();
                renderAll(); renderFrequent(); calcTotal();
                if(document.getElementById('cartModal').classList.contains('show')) cartModal.hide();
            }, 1000);
        }
    </script>
</body>
</html>
