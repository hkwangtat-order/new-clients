<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta property="og:title" content="è‡ªåŠ©é›»å­è½å–®è¡¨">
    <meta property="og:description" content="é¦™æ¸¯å®é”æœ‰é™å…¬å¸æä¾›">
    <title>å®é”è½å–®ç‹</title>

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#212529">
    <meta name="apple-mobile-web-app-title" content="å®é”è½å–®ç‹">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body { 
            font-family: "Microsoft JhengHei", sans-serif; 
            background-color: #f8f9fa; 
            padding-bottom: 160px; /* åº•éƒ¨é ç•™ç©ºé–“çµ¦è³¼ç‰©è»Šæ¬„ */
            -webkit-overflow-scrolling: touch; /* ç¢ºä¿æ»‘å‹•æµæš¢ */
        }

        /* === é ‚éƒ¨å®¹å™¨ (æ¢å¾©ç‚º Stickyï¼Œæœ€å®‰å…¨) === */
        .sticky-header-container { 
            position: sticky; 
            position: -webkit-sticky; /* å…¼å®¹ Safari */
            top: 0; 
            z-index: 1020; 
            background-color: #212529; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
            width: 100%;
            /* é©é…åŠ‰æµ·å±ï¼Œä½†ä¸å¼·åˆ¶é®æ“‹ */
            padding-top: env(safe-area-inset-top); 
            margin-top: -1px;
        }

        /* é ‚éƒ¨è³‡è¨Šæ¬„ */
        .top-info { 
            padding: 10px 15px 5px 15px; 
            color: white; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: relative;
            z-index: 2;
        }

        .client-name { font-size: 1.3rem; font-weight: 800; color: #ffc107; cursor: pointer; }

        /* å°èˆªæ¨™ç±¤ */
        .nav-tabs { 
            border-bottom: none; 
            padding: 0 10px; 
            background-color: #212529; 
            position: relative;
            z-index: 2;
        }
        .nav-link { color: #aaa; font-weight: bold; border: none; border-radius: 10px 10px 0 0; padding: 10px 15px; font-size: 1rem; background: transparent; }
        .nav-link.active { background-color: #f8f9fa; color: #000; border-bottom: 4px solid #ffc107; }

        /* æœç´¢æ¬„ */
        .search-section { background-color: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #ddd; display: none; }
        .search-wrapper { position: relative; }
        .search-input { border-radius: 20px; border: 1px solid #ccc; padding: 8px 35px 8px 15px; width: 100%; }
        .btn-clear-search { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #adb5bd; cursor: pointer; font-size: 1.1rem; display: none; z-index: 10; }

        /* åˆ†é¡æ¨™é¡Œ */
        .cat-header { 
            background-color: #ffc107; 
            color: #000; 
            font-weight: 800; 
            padding: 8px 15px; 
            margin-top: 0; 
            font-size: 1.1rem; 
            border-bottom: 1px solid #e0a800;
            position: relative; 
            z-index: 1;
        }

        /* ç”¢å“åˆ—è¡¨æ¨£å¼ */
        .product-row { background: white; border-bottom: 1px solid #eee; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        .product-row.oos { background-color: #f8f9fa; opacity: 0.8; }
        .p-info { flex: 1; padding-right: 10px; overflow: hidden; }
        .p-name { font-size: 1.1rem; font-weight: 700; color: #000; line-height: 1.3; margin-bottom: 2px; }
        .p-code { font-size: 0.85rem; color: #888; font-weight: normal; font-family: Arial, sans-serif; }
        .oos-badge { font-size: 0.8rem; background-color: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle; }

        /* æ•¸é‡æ§åˆ¶å™¨ */
        .qty-control { display: flex; align-items: center; background: #fff; border: 1px solid #ced4da; border-radius: 8px; width: 120px; justify-content: space-between; height: 38px; flex-shrink: 0; overflow: hidden; }
        .qty-control.disabled { background: #e9ecef; border-color: #dee2e6; }
        .qty-btn { width: 35px; height: 100%; border-radius: 0; background: #f8f9fa; color: #212529; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 1.2rem; user-select: none; border: none; }
        .qty-btn:active { background: #ffc107; }
        .qty-btn.disabled { color: #adb5bd; cursor: not-allowed; background: #e9ecef; }
        .qty-input { width: 50px; text-align: center; border: none; font-weight: bold; font-size: 1.1rem; color: #333; background: transparent; padding: 0; }
        .qty-input.unit-kg { color: #d63384; font-size: 1rem; }
        .product-row.selected { background-color: #fff9db; border-left: 5px solid #ffc107; }

        /* åº•éƒ¨è³¼ç‰©è»Š */
        .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; box-shadow: 0 -4px 15px rgba(0,0,0,0.15); padding: 10px 15px; z-index: 1030; display: flex; flex-direction: column; gap: 8px; }
        .bottom-info-row { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 2px; }
        .bottom-btn-row { display: flex; gap: 8px; width: 100%; }
        .total-box { font-size: 1.1rem; font-weight: bold; color: #333; }
        .total-num { color: #d32f2f; font-size: 1.4rem; padding: 0 3px; }
        .btn-view-cart { background-color: #6c757d; color: white; border: none; padding: 6px 15px; border-radius: 50px; font-weight: bold; font-size: 0.9rem; transition: all 0.3s ease; }
        .btn-view-cart.active { background: linear-gradient(45deg, #ff9800, #ff5722); box-shadow: 0 2px 8px rgba(255, 87, 34, 0.4); }
        .btn-send { border: none; padding: 12px 5px; border-radius: 10px; font-weight: bold; font-size: 1rem; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px; color: white; transition: transform 0.1s; }
        .btn-send:active { transform: scale(0.98); }
        .btn-sales { background-color: #25D366; box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3); } 
        .btn-group { background-color: #0d6efd; box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3); }

        /* å½ˆçª—èˆ‡è¨­å®š */
        .modal-footer { display: flex; gap: 8px; padding: 15px; justify-content: space-between; flex-wrap: wrap; }
        .modal-footer .btn { flex: 1; min-width: 100px; }
        .modal-footer .btn-outline-danger { flex: 0 0 auto; min-width: auto; border-radius: 50px; padding: 8px 15px; } 
        .modal-footer .btn-secondary { display: none; }
        .tab-content { display: none; padding-top: 10px; }
        .tab-content.active { display: block; }
        .modal-header { background-color: #212529; color: white; }
        .modal-title { font-weight: bold; color: #ffc107; }

        .unit-btn-group { display: flex; gap: 15px; justify-content: center; padding: 20px; }
        .btn-unit-select { flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 10px; background: white; font-weight: bold; font-size: 1.1rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .btn-unit-select:hover { background-color: #f8f9fa; }
        .btn-unit-select.piece { border-color: #212529; color: #212529; }
        .btn-unit-select.kg { border-color: #d63384; color: #d63384; }

        .freq-divider { text-align: center; margin: 20px 0; font-size: 0.85rem; color: #aaa; position: relative; }
        .freq-divider:before { content: ""; position: absolute; top: 50%; left: 15%; width: 25%; height: 1px; background: #ddd; }
        .freq-divider:after { content: ""; position: absolute; top: 50%; right: 15%; width: 25%; height: 1px; background: #ddd; }
        
        .setup-input-group { margin-bottom: 15px; text-align: left; }
        .setup-label { font-weight: bold; margin-bottom: 5px; display: block; color: #333; }
        .setup-input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .setup-input:focus { border-color: #ffc107; outline: none; }
        .btn-setup-save { width: 100%; background-color: #ffc107; color: black; font-weight: bold; padding: 12px; border: none; border-radius: 8px; font-size: 1.1rem; margin-top: 10px; }
        
        .admin-controls { text-align: center; margin: 40px 0 20px 0; padding-top: 20px; border-top: 1px dashed #ddd; display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .btn-reset { padding: 8px 20px; border-radius: 50px; font-size: 0.9rem; transition: all 0.2s; cursor: pointer; border: 1px solid; background: white; width: fit-content; }
        .btn-reset-freq { color: #6c757d; border-color: #ced4da; }
        .btn-reset-freq:hover { background: #f8f9fa; color: #495057; border-color: #adb5bd; }
        .btn-logout { color: #d32f2f; border-color: #f5c6cb; }
        .btn-logout:hover { background: #fff5f5; color: #a50e0e; border-color: #d32f2f; }
    </style>
</head>
<body onload="init()">

    <div class="sticky-header-container">
        <div class="top-info">
            <div id="backToAdminBtn" style="display:none; margin-right: 15px; cursor: pointer;">
                <i class="bi bi-arrow-left-circle-fill" style="font-size: 1.8rem; color: #ffc107;"></i>
            </div>

            <div id="clientInfoWrapper" onclick="openSetupModal()" style="flex: 1;">
                <div class="client-name" id="displayClientName">è¨­å®šå®¢æˆ¶ <i class="bi bi-pencil-square" style="font-size:0.8em"></i></div>
                <div style="font-size: 0.8rem; color: #ccc;" id="displayClientCode">é»æ“Šæ­¤è™•è¨­å®š</div>
            </div>
            
            <div style="text-align: right; font-size: 0.8rem; color: #ccc;">
                <span id="displaySalesName">å®é”æ‰¹ç™¼</span><br>Tel: <span id="displayPhone"></span>
            </div>
        </div>

        <ul class="nav nav-tabs nav-fill">
            <li class="nav-item">
                <button class="nav-link active" id="tab-freq" onclick="switchTab('freq')"><i class="bi bi-star-fill text-warning"></i> å¸¸ç”¨æ¸…å–®</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="tab-all" onclick="switchTab('all')"><i class="bi bi-clipboard-check"></i> å…¨éƒ¨ç”¢å“</button>
            </li>
        </ul>

        <div class="search-section" id="searchSection">
            <div class="search-wrapper">
                <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” æœå°‹ç”¢å“ / ç·¨è™Ÿ..." oninput="filterProducts()">
                <i class="bi bi-x-circle-fill btn-clear-search" id="clearSearchBtn" onclick="clearSearch()"></i>
            </div>
        </div>
    </div>

    <div id="freq-list" class="tab-content active"></div>
    <div id="all-list" class="tab-content"></div>

    <div class="bottom-bar">
        <div class="bottom-info-row">
            <div class="total-box">å…± <span class="total-num" id="totalCount">0</span> æ¬¾</div>
            <button class="btn-view-cart" id="viewCartBtn" onclick="viewCart()">
                <i class="bi bi-cart3"></i> æŸ¥çœ‹å·²é¸
            </button>
        </div>
        <div class="bottom-btn-row">
            <button class="btn-send btn-sales" onclick="sendWhatsApp('direct')">
                <i class="bi bi-whatsapp"></i> ç™¼é€çµ¦éŠ·å”®
            </button>
            <button class="btn-send btn-group" onclick="sendWhatsApp('group')">
                <i class="bi bi-people-fill"></i> ç™¼é€åˆ°ç¾¤çµ„
            </button>
        </div>
    </div>

    <div class="modal fade" id="cartModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“¦ å·²é¸ç”¢å“</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0" id="cartListBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" onclick="clearCart()"><i class="bi bi-trash3"></i> æ¸…ç©º</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="setupModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">âš™ï¸ è¨­å®šå®¢æˆ¶è³‡æ–™</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="setup-input-group">
                        <label class="setup-label">å®¢æˆ¶åç¨± (åº—å)</label>
                        <input type="text" id="setupName" class="setup-input" placeholder="ä¾‹å¦‚ï¼šç¾å‘³é¤å»³(æ—ºè§’)">
                    </div>
                    <div class="setup-input-group">
                        <label class="setup-label">å®¢æˆ¶ç·¨è™Ÿ (å¦‚ç„¡å¯ä¸å¡«)</label>
                        <input type="text" id="setupCode" class="setup-input" placeholder="ä¾‹å¦‚ï¼šW1234">
                    </div>
                    <button class="btn-setup-save" onclick="saveProfile()">ğŸ’¾ ä¿å­˜è¨­å®š</button>
                    
                    <div class="admin-controls">
                        <div class="btn-reset btn-reset-freq" onclick="resetFrequent()">
                            <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®å¸¸ç”¨æ¸…å–®
                        </div>
                        <div class="btn-reset btn-logout" onclick="logoutProfile()">
                            <i class="bi bi-box-arrow-right"></i> ç™»å‡º / åˆ‡æ›å¸³è™Ÿ
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="unitModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="unitModalTitle">é¸æ“‡å–®ä½</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="unit-btn-group">
                        <div class="btn-unit-select piece" onclick="confirmUnit('piece')">
                            <i class="bi bi-box-seam"></i><br>ä»¶ / ç›’ / åŒ…
                        </div>
                        <div class="btn-unit-select kg" onclick="confirmUnit('kg')">
                            <i class="bi bi-speedometer2"></i><br>KG (å…¬æ–¤)
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="products.js"></script>
    <script src="customers.js"></script>
    <script src="sales_config.js"></script> 

    <script>
        // æ ¸å¿ƒè®Šé‡
        let cart = {}; 
        let cartUnits = {}; 
        let itemCounts = {}; 
        let productMap = {};
        
        // å®¢æˆ¶ç‹€æ…‹
        let customerName = "";
        let customerCode = "";
        let salesID = "A"; 
        let currentSalesPhone = "63771688";
        let storageKey = "";
        let profileKey = ""; 
        let presetFrequent = []; 
        let learnedFrequent = [];
        let currentClientBoxItems = []; // ç•¶å‰å®¢æˆ¶çš„ç®±è²¨åå–®
        let currentClientAliasCodes = {}; // ç•¶å‰å®¢æˆ¶çš„ä»£ç¢¼è½‰æ›è¡¨

        let currentTab = 'freq';
        let tempUnitCode = null;

        // åˆå§‹åŒ–
        function init() {
            // 1. è¿”å›æŒ‰éˆ•é‚è¼¯
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('source') === 'admin') {
                const btn = document.getElementById('backToAdminBtn');
                if(btn) {
                    btn.style.display = 'block';
                    btn.onclick = function() {
                        window.location.href = 'admin.html';
                    };
                }
            }

            // 2. æ§‹å»ºç”¢å“åœ°åœ–
            productMap = {}; 
            if (typeof products !== 'undefined') {
                for(let p of products){
                    productMap[p.code] = p;
                }
            }

            // 3. è­˜åˆ¥ç”¨æˆ¶èˆ‡æ¸²æŸ“
            identifyUser();
            renderAll();
            renderFrequent();
            calcTotal();
            
            // ç›£è½æ»¾å‹•å„ªåŒ–
            window.addEventListener('scroll', function() {
                const s = document.getElementById('searchSection');
                if(window.scrollY > 50) s.style.display = 'block';
                else if(document.getElementById('searchInput').value === '') s.style.display = 'none';
            });
        }

        function identifyUser() {
            const urlParams = new URLSearchParams(window.location.search);
            const clientID = urlParams.get('id');
            const logoutBtn = document.querySelector('.btn-logout');
            const clientWrapper = document.getElementById('clientInfoWrapper');

            if (clientID && typeof clientDB !== 'undefined' && clientDB[clientID]) {
                // === è€å®¢æˆ¶ ===
                const client = clientDB[clientID];
                customerName = client.name;
                customerCode = client.realID || clientID;
                salesID = client.sales || "A"; 
                presetFrequent = client.list || []; 
                
                // è®€å–ç®±è²¨è¨­ç½®
                if (client.box_items) {
                    currentClientBoxItems = client.box_items;
                } else {
                    currentClientBoxItems = [];
                }

                // è®€å–ä»£ç¢¼è½‰æ›è¨­ç½®
                if (client.alias_codes) {
                    currentClientAliasCodes = client.alias_codes;
                } else {
                    currentClientAliasCodes = {};
                }

                document.getElementById('displayClientName').innerHTML = customerName;
                document.getElementById('displayClientCode').innerText = customerCode;
                
                // é–å®šè€å®¢æˆ¶é»æ“Š
                if(clientWrapper) {
                    clientWrapper.onclick = null; 
                    clientWrapper.style.pointerEvents = 'none';
                }
                if(logoutBtn) logoutBtn.style.display = 'none';
                
                storageKey = "client_user_" + clientID;

            } else {
                // === æ–°å®¢æˆ¶ ===
                salesID = urlParams.get('sales') || "A";
                profileKey = "gen_profile_" + salesID; 
                storageKey = "gen_user_" + salesID;

                customerName = localStorage.getItem(profileKey + "_name") || "";
                customerCode = localStorage.getItem(profileKey + "_code") || "";
                
                updateClientInfoUI(); 

                if(clientWrapper) {
                    clientWrapper.onclick = openSetupModal;
                    clientWrapper.style.pointerEvents = 'auto';
                }
                if(logoutBtn) logoutBtn.style.display = 'inline-block';
            }
            
            // è®€å–éŠ·å”®é›»è©±
            if (typeof salesTeam !== 'undefined' && salesTeam[salesID]) {
                currentSalesPhone = salesTeam[salesID].phone;
                document.getElementById('displaySalesName').innerText = "å®é” (" + salesTeam[salesID].name + ")";
            } else {
                document.getElementById('displaySalesName').innerText = "å®é”æ‰¹ç™¼";
            }
            document.getElementById('displayPhone').innerText = currentSalesPhone;

            // è®€å–è³¼ç‰©è»Šå’Œçµ±è¨ˆ
            const savedCart = localStorage.getItem(storageKey + '_cart');
            if(savedCart) { try { cart = JSON.parse(savedCart); } catch(e) {} }

            const savedUnits = localStorage.getItem(storageKey + '_units');
            if(savedUnits) { try { cartUnits = JSON.parse(savedUnits); } catch(e) {} }
            
            const savedStats = localStorage.getItem(storageKey + '_stats');
            if(savedStats) { try { itemCounts = JSON.parse(savedStats); } catch(e) {} }
            learnedFrequent = Object.keys(itemCounts);
        }

        // ... (ä¸­é–“çœç•¥ UI åˆ‡æ›ã€æœç´¢ç­‰åŸºç¤å‡½æ•¸ï¼Œä¿æŒåŸæ¨£å³å¯) ...
        
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.getElementById(tab + '-list').classList.add('active');
            window.scrollTo(0,0);
        }

        function updateClientInfoUI() {
            const nameEl = document.getElementById('displayClientName');
            const codeEl = document.getElementById('displayClientCode');
            if(customerName) {
                nameEl.innerHTML = customerName + ' <i class="bi bi-pencil-square" style="font-size:0.8em"></i>';
                codeEl.innerText = customerCode || "æœªè¨­å®šç·¨è™Ÿ";
                nameEl.style.color = "#ffc107";
            } else {
                nameEl.innerHTML = 'è¨­å®šå®¢æˆ¶ <i class="bi bi-pencil-square" style="font-size:0.8em"></i>';
                codeEl.innerText = "é»æ“Šæ­¤è™•è¨­å®š";
                nameEl.style.color = "#ffc107";
            }
        }

        function openSetupModal() {
            const modal = new bootstrap.Modal(document.getElementById('setupModal'));
            document.getElementById('setupName').value = customerName;
            document.getElementById('setupCode').value = customerCode;
            modal.show();
        }

        function saveProfile() {
            const n = document.getElementById('setupName').value.trim();
            const c = document.getElementById('setupCode').value.trim();
            if(!n) { alert("è«‹è¼¸å…¥å®¢æˆ¶åç¨±"); return; }
            
            customerName = n; 
            customerCode = c;
            localStorage.setItem(profileKey + "_name", customerName);
            localStorage.setItem(profileKey + "_code", customerCode);
            
            updateClientInfoUI();
            bootstrap.Modal.getInstance(document.getElementById('setupModal')).hide();
        }

        function logoutProfile() {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºä¸¦æ¸…é™¤æœ¬æ©Ÿè³‡æ–™å—ï¼Ÿ")) {
                localStorage.removeItem(profileKey + "_name");
                localStorage.removeItem(profileKey + "_code");
                localStorage.removeItem(storageKey + "_cart");
                localStorage.removeItem(storageKey + "_units");
                localStorage.removeItem(storageKey + "_stats");
                location.reload();
            }
        }

        function resetFrequent() {
            if(confirm("ç¢ºå®šè¦é‡ç½®å¸¸ç”¨æ¸…å–®çµ±è¨ˆå—ï¼Ÿ")) {
                localStorage.removeItem(storageKey + "_stats");
                itemCounts = {};
                learnedFrequent = [];
                renderFrequent();
                alert("å·²é‡ç½®ï¼");
            }
        }

        // æ ¸å¿ƒæ¸²æŸ“å‡½æ•¸
        function createRow(code) {
            const p = productMap[code];
            if(!p) return "";
            const q = cart[code] || 0;
            const isOOS = (p.oos === true);
            const rowClass = q > 0 ? "product-row selected" : (isOOS ? "product-row oos" : "product-row");
            const btnClass = isOOS ? "qty-btn disabled" : "qty-btn";
            
            // å–®ä½è™•ç†
            let unitLabel = "";
            let unitClass = "qty-input";
            if (cartUnits[code] === 'kg') {
                unitLabel = "KG";
                unitClass += " unit-kg";
            } else if (cartUnits[code] === 'piece' && code === 'B01') {
                unitLabel = "éš»";
            } else if (currentClientBoxItems.includes(code)) {
                unitLabel = "ç®±"; // åŸç®±é¡¯ç¤º
            }

            const oosLabel = isOOS ? '<span class="oos-badge">ç¼ºè²¨</span>' : '';
            
            return `
            <div class="${rowClass}" id="row-${code}">
                <div class="p-info">
                    <div class="p-name">${p.name}${oosLabel}</div>
                    <div class="p-code">${code} ${p.desc||""}</div>
                </div>
                <div class="qty-control ${isOOS?'disabled':''}">
                    <button class="${btnClass}" onclick="changeQty('${code}', -1)">âˆ’</button>
                    <input type="text" class="${unitClass}" id="qty-${code}" value="${q>0?q+(unitLabel?unitLabel:''):0}" readonly onclick="checkUnit('${code}')">
                    <button class="${btnClass}" onclick="changeQty('${code}', 1)">+</button>
                </div>
            </div>
            `;
        }

        function renderAll() {
            if (typeof categories === 'undefined') return;
            const container = document.getElementById('all-list');
            let html = "";
            
            for(let cat of categories) {
                // éæ¿¾è©²åˆ†é¡ä¸‹çš„ç”¢å“
                let catProds = products.filter(p => p.cat === cat).map(p => p.code);
                if(catProds.length === 0) continue;
                
                html += `<div class="cat-header">${cat}</div>`;
                for(let code of catProds) {
                    html += createRow(code);
                }
            }
            container.innerHTML = html + '<div style="height:80px"></div>';
        }

        function renderFrequent() {
            const container = document.getElementById('freq-list');
            // åˆä½µ é è¨­æ¸…å–® + å­¸ç¿’æ¸…å–®ï¼Œå»é‡
            let set = new Set([...presetFrequent, ...learnedFrequent]);
            let list = Array.from(set);
            
            // å¦‚æœåˆ—è¡¨ç‚ºç©º
            if(list.length === 0) {
                container.innerHTML = '<div class="text-center mt-5 text-muted">æš«ç„¡å¸¸ç”¨æ¸…å–®<br>è«‹åœ¨ã€Œå…¨éƒ¨ç”¢å“ã€ä¸­é¸æ“‡</div>';
                return;
            }

            let html = "";
            // æŒ‰åˆ†é¡æ’åºå±•ç¤º
            if (typeof categories !== 'undefined') {
                for(let cat of categories) {
                    let catProds = list.filter(c => productMap[c] && productMap[c].cat === cat);
                    if(catProds.length > 0) {
                        html += `<div class="cat-header">${cat}</div>`;
                        for(let code of catProds) {
                            html += createRow(code);
                        }
                    }
                }
            }
            // è™•ç†æœªåˆ†é¡æˆ–æ‰¾ä¸åˆ°åˆ†é¡çš„
            let otherProds = list.filter(c => productMap[c] && !categories.includes(productMap[c].cat));
            if(otherProds.length > 0) {
                html += `<div class="cat-header">å…¶ä»–</div>`;
                for(let code of otherProds) html += createRow(code);
            }

            // å¸¸ç”¨æ¸…å–®åº•éƒ¨æç¤º
            if(presetFrequent.length > 0 || learnedFrequent.length > 0) {
                 html += `<div class="freq-divider">ä»¥ä¸Šæ˜¯æ‚¨çš„å¸¸ç”¨æ¸…å–®</div>`;
            }

            container.innerHTML = html + '<div style="height:80px"></div>';
        }

        // è³¼ç‰©è»Šé‚è¼¯
        function checkUnit(code) {
            // åªæœ‰ B01 å’Œ D19EK é€™ç¨®ç‰¹æ®Šæ‰å½ˆçª—ï¼ŒåŸç®±çš„ä¸å½ˆ
            if (code === 'B01' || code === 'D19EK') {
                tempUnitCode = code;
                new bootstrap.Modal(document.getElementById('unitModal')).show();
            }
        }

        function confirmUnit(unit) {
            if(tempUnitCode) {
                cartUnits[tempUnitCode] = unit;
                saveCart();
                refreshRow(tempUnitCode);
                bootstrap.Modal.getInstance(document.getElementById('unitModal')).hide();
                tempUnitCode = null;
            }
        }

        function changeQty(code, delta) {
            if(productMap[code].oos) return;
            if(!cart[code]) cart[code] = 0;
            
            // ç‰¹æ®Šé‚è¼¯ï¼šå¦‚æœæ˜¯ B01 ä¸”ç¬¬ä¸€æ¬¡åŠ ï¼Œé»˜èªè¨­ç‚º KG
            if (code === 'B01' && cart[code] === 0 && delta > 0 && !cartUnits[code]) {
                cartUnits[code] = 'kg'; 
            }

            cart[code] += delta;
            if(cart[code] < 0) cart[code] = 0;
            if(cart[code] === 0) {
                delete cart[code];
                delete cartUnits[code];
            }
            
            saveCart();
            refreshRow(code);
            calcTotal();
        }

        function refreshRow(code) {
            // åŒæ™‚æ›´æ–°å¸¸ç”¨å’Œå…¨éƒ¨åˆ—è¡¨è£¡çš„è©²è¡Œ
            const row1 = document.querySelector(`#freq-list #row-${code}`);
            const row2 = document.querySelector(`#all-list #row-${code}`);
            const newHTML = createRow(code);
            // æå–æ–° HTML çš„å…§éƒ¨å…§å®¹æ›¿æ›
            const temp = document.createElement('div');
            temp.innerHTML = newHTML;
            const content = temp.firstElementChild.innerHTML;
            const className = temp.firstElementChild.className;

            if(row1) { row1.className = className; row1.innerHTML = content; }
            if(row2) { row2.className = className; row2.innerHTML = content; }
        }

        function calcTotal() {
            const count = Object.keys(cart).length;
            document.getElementById('totalCount').innerText = count;
            const btn = document.getElementById('viewCartBtn');
            if(count > 0) btn.classList.add('active');
            else btn.classList.remove('active');
        }

        function saveCart() {
            localStorage.setItem(storageKey + '_cart', JSON.stringify(cart));
            localStorage.setItem(storageKey + '_units', JSON.stringify(cartUnits));
        }

        function viewCart() {
            if(Object.keys(cart).length === 0) { alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„"); return; }
            const list = document.getElementById('cartListBody');
            let html = "";
            for(let c in cart) {
                html += createRow(c); // å¾©ç”¨ createRow
            }
            list.innerHTML = html;
            new bootstrap.Modal(document.getElementById('cartModal')).show();
        }

        function clearCart() {
            if(confirm("ç¢ºå®šæ¸…ç©ºè³¼ç‰©è»Šï¼Ÿ")) {
                cart = {}; cartUnits = {};
                saveCart();
                renderAll(); renderFrequent(); calcTotal();
                bootstrap.Modal.getInstance(document.getElementById('cartModal')).hide();
            }
        }

        function filterProducts() {
            const term = document.getElementById('searchInput').value.toUpperCase();
            document.getElementById('clearSearchBtn').style.display = term ? 'block' : 'none';
            
            // åˆ‡æ›åˆ°å…¨éƒ¨ç”¢å“é ç±¤
            if(currentTab !== 'all') switchTab('all');

            const rows = document.querySelectorAll('#all-list .product-row');
            const headers = document.querySelectorAll('#all-list .cat-header');

            rows.forEach(row => {
                const text = row.innerText.toUpperCase();
                row.style.display = text.includes(term) ? 'flex' : 'none';
            });
            
            // éš±è—ç©ºåˆ†é¡æ¨™é¡Œ (ç°¡å–®è™•ç†ï¼šå¦‚æœé‚„åœ¨æœç´¢å°±ä¸éš±è—æ¨™é¡Œäº†ï¼Œæˆ–è€…ä½ å¯ä»¥å„ªåŒ–)
            // é€™è£¡ç°¡å–®è™•ç†ï¼šæœç´¢æ™‚æ¨™é¡Œä¹Ÿé¡¯ç¤ºï¼Œæˆ–è€…å…¨éƒ¨éš±è—ã€‚
            // ç‚ºäº†ä¸å¾©é›œï¼Œæœç´¢æ™‚æš«æ™‚ä¸éš±è—åˆ†é¡æ¨™é¡Œ
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filterProducts();
            document.getElementById('searchSection').style.display = 'none';
        }

        // === ç™¼é€è¨‚å–®é‚è¼¯ (å« alias è½‰æ›) ===
        function sendWhatsApp(mode){
            if(!customerName || !customerCode) { alert("è«‹å…ˆè¨­å®šå®¢æˆ¶è³‡æ–™ï¼"); openSetupModal(); return; }
            if(Object.keys(cart).length===0){alert("è«‹å…ˆé¸æ“‡ç”¢å“ï¼");return}
            
            // è¨ˆç®—é€è²¨æ—¥æœŸ (æ˜å¤©)
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            const dateStr = (tomorrow.getMonth()+1) + "æœˆ" + tomorrow.getDate() + "æ—¥";
            
            let msg=`${customerCode} ${customerName}\næ—¥æœŸï¼š${dateStr}\nè¨‚è²¨å–®ï¼š\n\n`;
            
            // æ ¼å¼åŒ–å‡½æ•¸
            const fmt = c => {
                const p = productMap[c];
                const n = p ? p.name : c;
                let q = cart[c].toString();

                // å–®ä½åˆ¤æ–·
                if(cartUnits[c] === 'kg') { 
                    q += 'K';
                } 
                else if(cartUnits[c] === 'piece' && c === 'B01') { 
                    q += 'éš»';
                } 
                else if (currentClientBoxItems.includes(c)) {
                    q += 'ç®±'; 
                }

                // ä»£ç¢¼è½‰æ› (Alias Code)
                let displayCode = c;
                if (currentClientAliasCodes[c]) {
                    displayCode = currentClientAliasCodes[c];
                }

                return ` ${q.padEnd(5,' ')} ${n} (${displayCode})\n`;
            };
            
            let codes = Object.keys(cart).sort(); 
            let hasNewItems = false;
            for(let c of codes){
                msg+=fmt(c);
                // çµ±è¨ˆå¸¸ç”¨
                if(itemCounts[c]) itemCounts[c]++;
                else itemCounts[c] = 1;
                hasNewItems = true;
            }
            
            if(hasNewItems){
                localStorage.setItem(storageKey + '_stats', JSON.stringify(itemCounts));
            }

            if (mode === 'direct') {
                window.open(`https://api.whatsapp.com/send?phone=852${currentSalesPhone}&text=${encodeURIComponent(msg)}`,'_blank');
            } else {
                window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`,'_blank');
            }
            
            // æ¸…ç©ºä¸¦åˆ·æ–°
            setTimeout(() => {
                cart = {}; cartUnits = {};
                saveCart();
                renderAll(); renderFrequent(); calcTotal();
                if(document.getElementById('cartModal').classList.contains('show')) {
                    bootstrap.Modal.getInstance(document.getElementById('cartModal')).hide();
                }
            }, 1000);
        }
    </script>
</body>
</html>
